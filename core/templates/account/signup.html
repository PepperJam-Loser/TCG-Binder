{% extends "account/base_entrance.html" %}
{% load allauth i18n %}
{% block head_title %}
    {% trans "Signup" %}
{% endblock head_title %}
{% block content %}

<h1 class="text-xl text-center underline">Sign Up</h1>

<p class="text-center">Already have an account? <a href="/accounts/login/" class="btn-ghost text-blue-500">Sign in</a></p>

<form method="post" action="/accounts/signup/" class="rounded px-8 pt-6 pb-8 mb-0">
    {% csrf_token %}

    <div class="mb-1">
        <label for="id_username">Username:</label>
        <input type="text" name="username" placeholder="Username" autocomplete="username" minlength="1" maxlength="150" required id="id_username" 
        class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">
    </div>

    <div class="mb-3">
        <label for="id_email">Email:</label>
        <input type="email" name="email" placeholder="Email address" autocomplete="email" maxlength="320" required id="id_email" class="shadow appearance-none border rounded w-full py-2 px-3 
        leading-tight focus:outline-none focus:shadow-outline">
    </div>

    <div class="mb-5">
        <label for="id_password1">Password:</label>
        <input type="password" name="password1" placeholder="Password" autocomplete="new-password" required aria-describedby="id_password1_helptext" id="id_password1"
        class="shadow appearance-none border rounded w-full py-2 px-3 mb-3 leading-tight focus:outline-none focus:shadow-outline">
        <button type="button" onclick="togglePasswordVisibility('id_password1', 'toggleButton1')" id="toggleButton1" class="toggle-password text-sm text-blue-500">Show Password</button>
        <div class="text-sm">
            <span class="helptext" id="id_password1_helptext"><ul>
                <li>Your password can’t be too similar to your other personal information.</li>
                <li>Your password must contain at least 8 characters.</li>
                <li>Your password can’t be a commonly used password.</li>
                <li>Your password can’t be entirely numeric.</li>
            </ul></span>
        </div>
    </div>

    <div class="mb-7">
        <label for="id_password2">Enter your Password again:</label>
        <input type="password" name="password2" placeholder="Password" autocomplete="new-password" required aria-describedby="id_password2_helptext" id="id_password2"
        class="shadow appearance-none border rounded w-full py-2 px-3 mb-3 leading-tight focus:outline-none focus:shadow-outline">
        <button type="button" onclick="togglePasswordVisibility('id_password2', 'toggleButton2')" id="toggleButton2" class="toggle-password text-sm text-blue-500">Show Password</button>
    </div>
    
    <div class="md:flex md:items-center">
        <div class="md:w-1/3"></div>
        <div class="md:w-2/3">
            <button type="submit" class="shadow bg-blue-500 hover:bg-blue-700 focus:shadow-outline focus:outline-none text-white font-bold py-2 px-4 rounded">
                Sign Up
            </button>
        </div>
    </div>    
</form>
{% if SOCIALACCOUNT_ENABLED %}
    {% include "socialaccount/snippets/login.html" with page_layout="entrance" %}
{% endif %}

<!--Used ChatGPT to get script for recognizing passwords -->
<script>
    function debounce(func, wait, immediate) {
        var timeout;
        return function() {
            var context = this, args = arguments;
            var later = function() {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            var callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    }
    
    function validatePassword() {
    const password = document.getElementById('id_password1').value;
    const helptext = document.getElementById('id_password1_helptext');
    // Reset to initial color if input box is empty
    if (password === '') {
        helptext.style.color = ''; // Resets to stylesheet default
        return; // Exit the function early
    }

    const username = document.getElementById('id_username').value.toLowerCase();
    const email = document.getElementById('id_email').value.toLowerCase();
    const commonPasswords = ['password', '12345678', 'qwerty', '123456789'];

    const conditions = [
        password.length >= 8,
        !password.match(/^[\d]+$/),
        !username.includes(password.toLowerCase()) && !password.toLowerCase().includes(username) && 
        !email.includes(password.toLowerCase()) && !password.toLowerCase().includes(email.split('@')[0]),
        !commonPasswords.some(commonPassword => 
            commonPassword.includes(password.toLowerCase()) || password.toLowerCase().includes(commonPassword))
    ];

    if (conditions.every(condition => condition)) {
        helptext.style.color = 'green'; // Valid password
    } else {
        helptext.style.color = 'red'; // Invalid password
    }
}

    
    document.getElementById('id_password1').addEventListener('input', debounce(validatePassword, 500));
    
    function togglePasswordVisibility(passwordFieldId, toggleButtonId) {
        var passwordField = document.getElementById(passwordFieldId);
        var toggleButton = document.getElementById(toggleButtonId);
        if (passwordField.type === "password") {
            passwordField.type = "text";
            toggleButton.textContent = "Hide Password";
        } else {
            passwordField.type = "password";
            toggleButton.textContent = "Show Password";
        }
    }
</script>

{% endblock content %}
